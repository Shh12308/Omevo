<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ChatVibe - Next Generation Video Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>

<style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --secondary: #ec4899;
    --accent: #14b8a6;
    --dark: #0f172a;
    --dark-lighter: #1e293b;
    --dark-card: #334155;
    --text: #f1f5f9;
    --text-dim: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
  }

  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  html, body {
    width: 100%;
    height: 100%;
    font-family: 'Inter', sans-serif;
    background: var(--dark);
    color: var(--text);
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Permission Request Overlay */
  #permissionOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(10px);
  }

  #permissionOverlay.hidden {
    display: none;
  }

  .permission-card {
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 40px;
    max-width: 450px;
    width: 90%;
    text-align: center;
    animation: slideUp 0.5s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .permission-icon {
    font-size: 4rem;
    color: var(--primary);
    margin-bottom: 20px;
  }

  .permission-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 15px;
  }

  .permission-description {
    color: var(--text-dim);
    margin-bottom: 30px;
    line-height: 1.6;
  }

  .permission-features {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 30px;
  }

  .permission-feature {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: var(--dark);
    border-radius: 12px;
    text-align: left;
  }

  .permission-feature i {
    color: var(--success);
    font-size: 1.2rem;
  }

  .permission-feature-text {
    font-size: 0.9rem;
  }

  .permission-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  .permission-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .permission-btn.primary {
    background: var(--gradient);
    color: white;
  }

  .permission-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
  }

  .permission-btn.secondary {
    background: var(--dark);
    color: var(--text);
    border: 1px solid var(--glass-border);
  }

  .permission-btn.secondary:hover {
    border-color: var(--primary);
  }

  .permission-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Loading Screen */
  #loadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: var(--dark);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9998;
    flex-direction: column;
  }

  #loadingScreen.hidden {
    display: none;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--glass-border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .loading-text {
    font-size: 1.2rem;
    color: var(--text-dim);
  }

  /* Animated Background */
  #bgCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    opacity: 0.3;
  }

  /* Main App Container */
  #app {
    position: relative;
    width: 100%;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1;
  }

  /* Video Container */
  .video-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at center, var(--dark-lighter) 0%, var(--dark) 100%);
  }

  /* Remote Video */
  #remoteVideoWrapper {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: var(--dark);
    overflow: hidden;
  }

  #remoteVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
    transition: filter 0.3s ease;
  }

  /* Local Video - Now fully draggable */
  #localVideoWrapper {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 180px;
    height: 240px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    border: 2px solid var(--glass-border);
    background: var(--dark);
    transition: box-shadow 0.3s ease;
    z-index: 1000;
    cursor: move;
    touch-action: none;
  }

  #localVideoWrapper:hover {
    box-shadow: 0 15px 50px rgba(99, 102, 241, 0.3);
  }

  #localVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
  }

  /* PiP Button */
  #pipBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 15;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #localVideoWrapper:hover #pipBtn {
    opacity: 1;
  }

  /* Reset Button */
  #resetPositionBtn {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 15;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #localVideoWrapper:hover #resetPositionBtn {
    opacity: 1;
  }

  /* Video Overlay Effects */
  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
  }

  /* Blur Overlay for Searching */
  #blurOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(10px);
    background: rgba(0, 0, 0, 0.7);
    z-index: 45;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  #blurOverlay.active {
    display: flex;
  }

  /* Partner Info Card */
  #partnerInfo {
    position: absolute;
    top: 30px;
    left: 30px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px 25px;
    min-width: 250px;
    max-width: 300px;
    z-index: 20;
    animation: slideInLeft 0.5s ease;
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  #partnerInfo .name {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #partnerInfo .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: var(--gradient);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  #partnerInfo .details {
    color: var(--text-dim);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  #partnerInfo .interests {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .interest-tag {
    padding: 6px 12px;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    font-size: 0.8rem;
    color: var(--text-dim);
    transition: all 0.2s ease;
  }

  .interest-tag:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  /* Control Panel - Fixed to fit 6 buttons */
  #controls {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    padding: 15px 20px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 30px;
    z-index: 30;
    animation: slideInUp 0.5s ease;
    max-width: 90%;
    overflow-x: auto;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  .control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: var(--glass);
    color: var(--text);
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
  }

  .control-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: var(--primary);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .control-btn:hover::before {
    width: 100%;
    height: 100%;
  }

  .control-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
  }

  .control-btn:hover i {
    position: relative;
    z-index: 1;
  }

  .control-btn.primary {
    background: var(--gradient);
    color: white;
  }

  .control-btn.danger {
    background: var(--danger);
    color: white;
  }

  .control-btn.active {
    background: var(--success);
    color: white;
  }

  /* Side Panels - Fixed positioning */
  .side-panel {
    position: fixed;
    top: 0;
    width: 320px;
    height: 100vh;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    z-index: 40;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
  }

  .side-panel.left {
    left: 0;
    transform: translateX(-100%);
    border-right: 1px solid var(--glass-border);
  }

  .side-panel.left.open {
    transform: translateX(0);
  }

  .side-panel.right {
    right: 0;
    transform: translateX(100%);
    border-left: 1px solid var(--glass-border);
  }

  .side-panel.right.open {
    transform: translateX(0);
  }

  .panel-header {
    padding: 25px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .panel-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .panel-content {
    padding: 25px;
  }

  /* Settings Form */
  .form-group {
    margin-bottom: 25px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    background: var(--dark);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    color: var(--text);
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
  }

  .btn-primary {
    background: var(--gradient);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
  }

  /* Chat System */
  #chatPanel {
    position: fixed;
    bottom: -400px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    height: 400px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px 20px 0 0;
    z-index: 35;
    transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
  }

  #chatPanel.open {
    bottom: 0;
  }

  .chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .message {
    display: flex;
    gap: 10px;
    animation: messageSlide 0.3s ease;
  }

  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message.own {
    flex-direction: row-reverse;
  }

  .message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    background: var(--dark-card);
    border-radius: 18px;
    position: relative;
  }

  .message.own .message-bubble {
    background: var(--primary);
  }

  .message-input {
    padding: 15px 20px;
    border-top: 1px solid var(--glass-border);
    display: flex;
    gap: 10px;
  }

  .message-input input {
    flex: 1;
    padding: 10px 15px;
    background: var(--dark);
    border: 1px solid var(--glass-border);
    border-radius: 25px;
    color: var(--text);
    font-size: 0.9rem;
  }

  .message-input button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .message-input button:hover {
    transform: scale(1.1);
  }

  /* Matching Screen - Now as an overlay */
  #matchingScreen {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 400px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    z-index: 50;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
  }

  #matchingScreen.active {
    display: flex;
  }

  .matching-content {
    width: 100%;
  }

  .pulse-animation {
    width: 120px;
    height: 120px;
    margin: 0 auto 30px;
    background: var(--gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
    }
    70% {
      box-shadow: 0 0 0 30px rgba(99, 102, 241, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
    }
  }

  .matching-text {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .matching-subtext {
    color: var(--text-dim);
    font-size: 1rem;
    margin-bottom: 20px;
  }

  .cancel-btn {
    padding: 10px 20px;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
  }

  .cancel-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
  }

  /* Report Modal */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--dark-lighter);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: modalSlide 0.3s ease;
  }

  @keyframes modalSlide {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    margin-bottom: 20px;
  }

  .modal-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
  }

  .report-reasons {
    display: grid;
    gap: 10px;
    margin-bottom: 20px;
  }

  .report-option {
    padding: 15px;
    background: var(--dark);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .report-option:hover {
    border-color: var(--primary);
    transform: translateX(5px);
  }

  .report-option.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
  }

  /* Stats Bar */
  #statsBar {
    position: fixed;
    top: 30px;
    right: 30px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    gap: 30px;
    z-index: 20;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Floating Action Buttons */
  .fab {
    position: fixed;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--gradient);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
    transition: all 0.3s ease;
    z-index: 25;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
  }

  .fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(99, 102, 241, 0.4);
  }

  #settingsFab {
    top: 30px;
    left: 30px;
  }

  #profileFab {
    top: 100px;
    left: 30px;
  }

  /* Notification Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--dark-lighter);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    min-width: 300px;
    z-index: 200;
    animation: toastSlide 0.3s ease;
    transform: translateX(400px);
  }

  .toast.show {
    transform: translateX(0);
  }

  @keyframes toastSlide {
    from {
      transform: translateX(400px);
    }
    to {
      transform: translateX(0);
    }
  }

  .toast-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .toast.success .toast-icon {
    background: var(--success);
    color: white;
  }

  .toast.error .toast-icon {
    background: var(--danger);
    color: white;
  }

  .toast.info .toast-icon {
    background: var(--primary);
    color: white;
  }

  .toast-content {
    flex: 1;
  }

  .toast-title {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .toast-message {
    font-size: 0.9rem;
    color: var(--text-dim);
  }

  /* Premium Badge */
  .premium-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Level Badge */
  .level-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--gradient);
    color: white;
    font-weight: 700;
    font-size: 0.8rem;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    #localVideoWrapper {
      width: 100px;
      height: 140px;
      bottom: 120px;
      right: 20px;
    }

    #controls {
      bottom: 20px;
      padding: 12px 15px;
      gap: 6px;
      max-width: 95%;
    }

    .control-btn {
      width: 40px;
      height: 40px;
      font-size: 0.9rem;
    }

    #partnerInfo {
      top: 20px;
      left: 20px;
      padding: 15px 20px;
      min-width: 200px;
      max-width: 250px;
    }

    #statsBar {
      display: none;
    }

    .side-panel {
      width: 100%;
    }

    #chatPanel {
      width: 100%;
      height: 350px;
    }

    #matchingScreen {
      width: 95%;
    }

    .permission-card {
      padding: 30px 20px;
    }

    .permission-features {
      grid-template-columns: 1fr;
    }
  }

  /* Loading Spinner */
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass-border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  /* Virtual Gifts */
  .gift-animation {
    position: fixed;
    font-size: 3rem;
    z-index: 90;
    animation: giftFloat 3s ease-out forwards;
    pointer-events: none;
  }

  @keyframes giftFloat {
    0% {
      opacity: 0;
      transform: translateY(100px) scale(0);
    }
    50% {
      opacity: 1;
      transform: translateY(-50px) scale(1.2);
    }
    100% {
      opacity: 0;
      transform: translateY(-150px) scale(0.8);
    }
  }

  /* Effects Toggle */
  .effects-panel {
    position: fixed;
    bottom: 120px;
    right: 30px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px;
    display: none;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    z-index: 30;
  }

  .effects-panel.active {
    display: grid;
  }

  .effect-btn {
    width: 60px;
    height: 60px;
    border: 2px solid transparent;
    border-radius: 12px;
    background: var(--dark);
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .effect-btn:hover {
    border-color: var(--primary);
    transform: scale(1.1);
  }

  .effect-btn.active {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.2);
  }

  /* Payment Modal */
  .payment-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }

  .payment-modal.active {
    display: flex;
  }

  .payment-content {
    background: var(--dark-lighter);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: modalSlide 0.3s ease;
  }

  .coins-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
  }

  .coin-packages {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
  }

  .coin-package {
    padding: 15px;
    background: var(--dark);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .coin-package:hover {
    border-color: var(--primary);
    transform: translateY(-5px);
  }

  .coin-package.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
  }

  .coin-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
  }

  .coin-price {
    font-size: 1rem;
    color: var(--text-dim);
  }

  /* Age Verification Modal */
  .age-verification {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }

  .age-content {
    background: var(--dark-lighter);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    text-align: center;
  }

  .age-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
  }

  .age-description {
    margin-bottom: 20px;
    color: var(--text-dim);
  }

  /* Device Selector */
  .device-selector {
    position: fixed;
    bottom: 150px;
    right: 30px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px;
    display: none;
    flex-direction: column;
    gap: 10px;
    z-index: 30;
  }

  .device-selector.active {
    display: flex;
  }

  .device-option {
    padding: 10px 15px;
    background: var(--dark);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .device-option:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
  }

  .device-option.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.2);
  }
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading ChatVibe...</div>
</div>

<!-- Permission Request Overlay -->
<div id="permissionOverlay">
  <div class="permission-card">
    <div class="permission-icon">
      <i class="fas fa-video"></i>
    </div>
    <h2 class="permission-title">Camera & Microphone Required</h2>
    <p class="permission-description">
      ChatVibe needs access to your camera and microphone to connect you with others through video chat. Your privacy is important to us - you're always in control of when your camera is on.
    </p>
    
    <div class="permission-features">
      <div class="permission-feature">
        <i class="fas fa-check-circle"></i>
        <div class="permission-feature-text">HD Video Quality</div>
      </div>
      <div class="permission-feature">
        <i class="fas fa-check-circle"></i>
        <div class="permission-feature-text">Clear Audio</div>
      </div>
      <div class="permission-feature">
        <i class="fas fa-check-circle"></i>
        <div class="permission-feature-text">Privacy Protected</div>
      </div>
      <div class="permission-feature">
        <i class="fas fa-check-circle"></i>
        <div class="permission-feature-text">Safe & Secure</div>
      </div>
    </div>
    
    <div class="permission-buttons">
      <button class="permission-btn secondary" onclick="denyPermissions()">
        Maybe Later
      </button>
      <button class="permission-btn primary" onclick="requestPermissions()">
        Allow Access
      </button>
    </div>
  </div>
</div>

<!-- Animated Background Canvas -->
<canvas id="bgCanvas"></canvas>

<!-- Main App -->
<div id="app">
  <!-- Video Container -->
  <div class="video-container">
    <!-- Remote Video -->
    <div id="remoteVideoWrapper">
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="video-overlay"></div>
    </div>

    <!-- Blur Overlay for Searching -->
    <div id="blurOverlay">
      <!-- Matching Screen Content -->
      <div class="matching-content">
        <div class="pulse-animation">
          <i class="fas fa-search" style="font-size: 3rem; color: white;"></i>
        </div>
        <div class="matching-text">Finding someone to chat with...</div>
        <div class="matching-subtext">This usually takes less than 10 seconds</div>
        <div class="spinner"></div>
        <button class="cancel-btn" onclick="stopMatching()">Cancel Search</button>
      </div>
    </div>

    <!-- Local Video - Now fully draggable -->
    <div id="localVideoWrapper">
      <video id="localVideo" autoplay muted playsinline></video>
      <button id="pipBtn" title="Picture-in-Picture">
        <i class="fas fa-external-link-alt"></i>
      </button>
      <button id="resetPositionBtn" title="Reset Position">
        <i class="fas fa-compress"></i>
      </button>
    </div>

    <!-- Partner Info -->
    <div id="partnerInfo" style="display: none;">
      <div class="name">
        <span id="partnerName">Stranger</span>
        <span class="badge">
          <i class="fas fa-check-circle"></i>
          Verified
        </span>
      </div>
      <div class="details">
        <div><i class="fas fa-map-marker-alt"></i> <span id="partnerLocation">Unknown</span></div>
        <div><i class="fas fa-venus-mars"></i> <span id="partnerGender">Unknown</span></div>
        <div><i class="fas fa-heart"></i> <span id="partnerInterests">No interests</span></div>
      </div>
      <div class="interests" id="partnerInterestsList"></div>
    </div>

    <!-- Stats Bar -->
    <div id="statsBar">
      <div class="stat-item">
        <div class="stat-value" id="matchCount">0</div>
        <div class="stat-label">Matches</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="timeCount">0:00</div>
        <div class="stat-label">Time</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="levelCount">1</div>
        <div class="stat-label">Level</div>
      </div>
    </div>

    <!-- Controls - Now with 6 buttons -->
    <div id="controls">
      <div id="startControls" style="display: flex; gap: 8px;">
        <button class="control-btn primary" id="startBtn" title="Start Chatting">
          <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" id="giftsBtn" title="Send Gift">
          <i class="fas fa-gift"></i>
        </button>
        <button class="control-btn" id="effectsBtn" title="Video Effects">
          <i class="fas fa-magic"></i>
        </button>
      </div>

      <div id="activeControls" style="display: none; gap: 8px;">
        <button class="control-btn" id="nextBtn" title="Next">
          <i class="fas fa-forward"></i>
        </button>
        <button class="control-btn" id="chatBtn" title="Chat">
          <i class="fas fa-comment"></i>
        </button>
        <button class="control-btn" id="reportBtn" title="Report">
          <i class="fas fa-flag"></i>
        </button>
        <button class="control-btn" id="likeBtn" title="Like">
          <i class="fas fa-heart"></i>
        </button>
        <button class="control-btn" id="stopBtn" title="Stop">
          <i class="fas fa-stop"></i>
        </button>
        <button class="control-btn" id="cameraBtn" title="Switch Camera">
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>

    <!-- Effects Panel -->
    <div class="effects-panel" id="effectsPanel">
      <button class="effect-btn" data-effect="none" title="No Effect">
        <i class="fas fa-ban"></i>
      </button>
      <button class="effect-btn" data-effect="blur" title="Blur">
        <i class="fas fa-eye-slash"></i>
      </button>
      <button class="effect-btn" data-effect="grayscale" title="B&W">
        <i class="fas fa-adjust"></i>
      </button>
      <button class="effect-btn" data-effect="sepia" title="Sepia">
        <i class="fas fa-image"></i>
      </button>
      <button class="effect-btn" data-effect="invert" title="Invert">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="effect-btn" data-effect="contrast" title="High Contrast">
        <i class="fas fa-sun"></i>
      </button>
    </div>

    <!-- Device Selector -->
    <div class="device-selector" id="deviceSelector">
      <div class="device-option" data-device-id="">
        <i class="fas fa-video"></i>
        <span>Default Camera</span>
      </div>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div class="side-panel left" id="settingsPanel">
  <div class="panel-header">
    <h2>Settings</h2>
    <button class="control-btn" onclick="toggleSettings()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="panel-content">
    <div class="form-group">
      <label>I am</label>
      <select class="form-control" id="genderSelect">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="form-group">
      <label>Looking for</label>
      <select class="form-control" id="lookingForSelect">
        <option value="any">Anyone</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="form-group">
      <label>Location</label>
      <select class="form-control" id="locationSelect">
        <option value="any">Anywhere</option>
        <option value="nearby">Nearby</option>
        <option value="usa">United States</option>
        <option value="europe">Europe</option>
        <option value="asia">Asia</option>
      </select>
    </div>

    <div class="form-group">
      <label>Interests</label>
      <input type="text" class="form-control" id="interestsInput" placeholder="Music, Gaming, Sports...">
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" id="verifiedOnly"> Verified users only
      </label>
    </div>

    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
  </div>
</div>

<!-- Profile Panel -->
<div class="side-panel right" id="profilePanel">
  <div class="panel-header">
    <h2>Profile</h2>
    <button class="control-btn" onclick="toggleProfile()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="panel-content">
    <div style="text-align: center; margin-bottom: 20px;">
      <div id="profileAvatar" style="width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; overflow: hidden;">
        <i class="fas fa-user"></i>
      </div>
      <h3 id="profileName">Guest User</h3>
      <div class="premium-badge" style="display: none;">
        <i class="fas fa-crown"></i>
        Premium
      </div>
      <div class="level-badge" id="profileLevel">1</div>
      <div class="coins-display" id="coinsDisplay" style="display: none;">
        <i class="fas fa-coins"></i>
        <span id="coinsAmount">0</span>
      </div>
    </div>

    <div class="form-group">
      <label>Display Name</label>
      <input type="text" class="form-control" id="displayNameInput" placeholder="Enter your name">
    </div>

    <div class="form-group">
      <label>Bio</label>
      <textarea class="form-control" id="bioInput" rows="3" placeholder="Tell us about yourself..."></textarea>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
      <div style="text-align: center; padding: 15px; background: var(--dark); border-radius: 12px;">
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="totalMatches">0</div>
        <div style="font-size: 0.8rem; color: var(--text-dim);">Total Matches</div>
      </div>
      <div style="text-align: center; padding: 15px; background: var(--dark); border-radius: 12px;">
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="likesCount">0</div>
        <div style="font-size: 0.8rem; color: var(--text-dim);">Likes Received</div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
    <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 10px; background: var(--warning);">
      <i class="fas fa-coins"></i> Get Coins
    </button>
    <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px; width: 100%;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- Chat Panel -->
<div id="chatPanel">
  <div class="chat-header">
    <h3>Chat</h3>
    <button class="control-btn" onclick="toggleChat()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="message-input">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>

<!-- Report Modal -->
<div class="modal" id="reportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Report User</h3>
    </div>
    <div class="report-reasons">
      <div class="report-option" data-reason="inappropriate_behavior">
        <i class="fas fa-user-times"></i> Inappropriate Behavior
      </div>
      <div class="report-option" data-reason="spam">
        <i class="fas fa-ban"></i> Spam or Scam
      </div>
      <div class="report-option" data-reason="underage">
        <i class="fas fa-child"></i> Underage User
      </div>
      <div class="report-option" data-reason="violence">
        <i class="fas fa-fist-raised"></i> Violence or Threats
      </div>
      <div class="report-option" data-reason="nudity">
        <i class="fas fa-eye-slash"></i> Nudity or Sexual Content
      </div>
      <div class="report-option" data-reason="other">
        <i class="fas fa-exclamation-triangle"></i> Other
      </div>
    </div>
    <div class="form-group">
      <label>Additional details (optional)</label>
      <textarea class="form-control" id="reportDetails" rows="3" placeholder="Provide more information..."></textarea>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-primary" onclick="submitReport()">Submit Report</button>
      <button class="btn" style="background: var(--dark);" onclick="closeReportModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Gifts Modal -->
<div class="modal" id="giftsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Send a Gift</h3>
      <button class="control-btn" onclick="closeGiftsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px;">
      <button class="gift-btn" onclick="sendGift('rose')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">üåπ</div>
        <div style="font-weight: 600;">Rose</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">10 coins</div>
      </button>
      <button class="gift-btn" onclick="sendGift('heart')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">‚ù§Ô∏è</div>
        <div style="font-weight: 600;">Heart</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">15 coins</div>
      </button>
      <button class="gift-btn" onclick="sendGift('star')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">‚≠ê</div>
        <div style="font-weight: 600;">Star</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">20 coins</div>
      </button>
      <button class="gift-btn" onclick="sendGift('diamond')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">üíé</div>
        <div style="font-weight: 600;">Diamond</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">50 coins</div>
      </button>
      <button class="gift-btn" onclick="sendGift('crown')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">üëë</div>
        <div style="font-weight: 600;">Crown</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">100 coins</div>
      </button>
      <button class="gift-btn" onclick="sendGift('rocket')" style="padding: 20px; background: var(--dark); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
        <div style="font-size: 2.5rem; margin-bottom: 5px;">üöÄ</div>
        <div style="font-weight: 600;">Rocket</div>
        <div style="color: var(--text-dim); font-size: 0.9rem;">200 coins</div>
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-content">
    <div class="modal-header">
      <h3>Get Coins</h3>
      <button class="control-btn" onclick="closePaymentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="coins-display">
      <i class="fas fa-coins"></i>
      <span id="currentCoins">0</span>
    </div>
    <div class="coin-packages">
      <div class="coin-package" data-coins="100" data-price="4.99">
        <div class="coin-amount">100</div>
        <div class="coin-price">$4.99</div>
      </div>
      <div class="coin-package" data-coins="250" data-price="9.99">
        <div class="coin-amount">250</div>
        <div class="coin-price">$9.99</div>
      </div>
      <div class="coin-package" data-coins="500" data-price="19.99">
        <div class="coin-amount">500</div>
        <div class="coin-price">$19.99</div>
      </div>
      <div class="coin-package" data-coins="1000" data-price="39.99">
        <div class="coin-amount">1000</div>
        <div class="coin-price">$39.99</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="purchaseCoins()" style="width: 100%; margin-top: 20px;">
      Purchase Coins
    </button>
  </div>
</div>

<!-- Age Verification Modal -->
<div class="age-verification" id="ageVerification" style="display: none;">
  <div class="age-content">
    <div class="age-title">Age Verification Required</div>
    <div class="age-description">
      You must be at least 18 years old to use video features. Please confirm your age to continue.
    </div>
    <div class="form-group">
      <label>Your Age</label>
      <input type="number" class="form-control" id="ageInput" min="18" max="120" placeholder="Enter your age">
    </div>
    <button class="btn btn-primary" onclick="verifyAge()">Verify Age</button>
  </div>
</div>

<!-- Floating Action Buttons -->
<button class="fab" id="settingsFab" onclick="toggleSettings()" title="Settings">
  <i class="fas fa-cog"></i>
</button>
<button class="fab" id="profileFab" onclick="toggleProfile()" title="Profile">
  <i class="fas fa-user"></i>
</button>

<!-- Agora SDK -->
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<script>
/* =====================================================
   CONFIG & STATE
===================================================== */
const BACKEND = "https://term-2gkk.onrender.com";
const AGORA_APP_ID = "0f9094ed4a8e4dea934059b0ea8b5182";

let token = localStorage.getItem("token");
let socket = null;
let client = null;
let localTracks = {};
let currentRoom = null;
let partnerId = null;
let isMatching = false;
let isInCall = false;
let matchTimer = null;
let matchSeconds = 0;
let isPipActive = false;
let userCoins = 0;
let selectedCoinPackage = null;
let permissionsGranted = false;
let mediaStream = null;
let availableCameras = [];
let availableMicrophones = [];
let stripe = null;

const state = {
  user: null,
  preferences: {
    gender: 'male',
    lookingFor: 'any',
    location: 'any',
    interests: [],
    verifiedOnly: false
  },
  stats: {
    matches: 0,
    likes: 0,
    time: 0,
    level: 1
  }
};

/* =====================================================
   AUTHENTICATION & PERMISSIONS
===================================================== */
function checkAuthentication() {
  // Check if user is logged in
  if (!token) {
    // Redirect to login page
    window.location.href = "/index.html";
    return false;
  }
  
  // Check if token is expired (basic check)
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const now = Date.now() / 1000;
    
    if (payload.exp < now) {
      // Token expired, remove it and redirect to login
      localStorage.removeItem("token");
      window.location.href = "/index.html";
      return false;
    }
  } catch (error) {
    // Invalid token, remove it and redirect to login
    localStorage.removeItem("token");
    window.location.href = "/index.html";
    return false;
  }
  
  return true;
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "/index.html";
}

async function requestPermissions() {
  const allowBtn = document.querySelector('.permission-btn.primary');
  const denyBtn = document.querySelector('.permission-btn.secondary');
  
  allowBtn.disabled = true;
  denyBtn.disabled = true;
  allowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting...';
  
  try {
    // Request camera and microphone permissions
    mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    
    // Store the stream for later use
    localTracks.audioTrack = mediaStream.getAudioTracks()[0];
    localTracks.videoTrack = mediaStream.getVideoTracks()[0];
    
    // Get available devices
    await getDevices();
    
    // Show video in local preview
    const localVideo = document.getElementById('localVideo');
    localVideo.srcObject = mediaStream;
    
    permissionsGranted = true;
    
    // Hide permission overlay
    document.getElementById('permissionOverlay').classList.add('hidden');
    
    // Initialize the app
    await initializeApp();
    
  } catch (error) {
    console.error('Permission denied:', error);
    
    allowBtn.disabled = false;
    denyBtn.disabled = false;
    allowBtn.innerHTML = 'Allow Access';
    
    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
      showToast('Camera and microphone access is required to use ChatVibe. Please allow access in your browser settings.', 'error');
    } else {
      showToast('Failed to access camera and microphone. Please check your device settings.', 'error');
    }
  }
}

async function getDevices() {
  try {
    // Get all video devices
    const videoDevices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = videoDevices.filter(device => device.kind === 'videoinput');
    
    // Get all audio devices
    const audioDevices = await navigator.mediaDevices.enumerateDevices();
    availableMicrophones = audioDevices.filter(device => device.kind === 'audioinput');
    
    // Populate device selector
    const deviceSelector = document.getElementById('deviceSelector');
    deviceSelector.innerHTML = '';
    
    // Add default option
    const defaultOption = document.createElement('div');
    defaultOption.className = 'device-option selected';
    defaultOption.dataset.deviceId = '';
    defaultOption.innerHTML = '<i class="fas fa-video"></i><span>Default Camera</span>';
    deviceSelector.appendChild(defaultOption);
    
    // Add other cameras
    availableCameras.forEach((camera, index) => {
      if (index > 0) { // Skip the first one as it's the default
        const option = document.createElement('div');
        option.className = 'device-option';
        option.dataset.deviceId = camera.deviceId;
        
        const label = camera.label || `Camera ${index + 1}`;
        option.innerHTML = `<i class="fas fa-video"></i><span>${label}</span>`;
        
        option.addEventListener('click', () => selectCamera(camera.deviceId));
        deviceSelector.appendChild(option);
      }
    });
    
    // Add click event to default option
    defaultOption.addEventListener('click', () => selectCamera(''));
    
  } catch (error) {
    console.error('Error getting devices:', error);
  }
}

async function selectCamera(deviceId) {
  try {
    // Update selected state
    document.querySelectorAll('.device-option').forEach(opt => {
      opt.classList.remove('selected');
    });
    
    const selectedOption = document.querySelector(`.device-option[data-device-id="${deviceId}"]`);
    if (selectedOption) {
      selectedOption.classList.add('selected');
    }
    
    // Stop current tracks
    if (localTracks.videoTrack) {
      localTracks.videoTrack.stop();
      localTracks.videoTrack = null;
    }
    
    // Get new stream with selected camera
    const constraints = {
      video: deviceId ? { deviceId: { exact: deviceId } } : true,
      audio: true
    };
    
    const newStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    // Update tracks
    localTracks.audioTrack = newStream.getAudioTracks()[0];
    localTracks.videoTrack = newStream.getVideoTracks()[0];
    
    // Update video element
    const localVideo = document.getElementById('localVideo');
    localVideo.srcObject = newStream;
    
    // If in a call, publish the new track
    if (client && isInCall) {
      await client.unpublish(localTracks.videoTrack);
      await client.publish(localTracks.videoTrack);
    }
    
    showToast('Camera switched successfully', 'success');
    
  } catch (error) {
    console.error('Error switching camera:', error);
    showToast('Failed to switch camera', 'error');
  }
}

function denyPermissions() {
  showToast('Camera and microphone access is required to use ChatVibe. You can grant access later in your browser settings.', 'info');
  
  // Hide the overlay but show a message that permissions are needed
  document.getElementById('permissionOverlay').classList.add('hidden');
  
  // Show a persistent message about permissions
  const permissionMessage = document.createElement('div');
  permissionMessage.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--warning);
    color: white;
    padding: 15px 20px;
    border-radius: 12px;
    z-index: 1000;
    max-width: 400px;
    text-align: center;
  `;
  permissionMessage.innerHTML = `
    <i class="fas fa-exclamation-triangle"></i> 
    Camera & microphone access required. 
    <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: white; color: var(--warning); border: none; border-radius: 5px; cursor: pointer;">
      Try Again
    </button>
  `;
  document.body.appendChild(permissionMessage);
}

/* =====================================================
   ANIMATED BACKGROUND
===================================================== */
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.speedX = Math.random() * 0.5 - 0.25;
    this.speedY = Math.random() * 0.5 - 0.25;
    this.opacity = Math.random() * 0.5 + 0.2;
  }

  update() {
    this.x += this.speedX;
    this.y += this.speedY;

    if (this.x > canvas.width) this.x = 0;
    if (this.x < 0) this.x = canvas.width;
    if (this.y > canvas.height) this.y = 0;
    if (this.y < 0) this.y = canvas.height;
  }

  draw() {
    ctx.fillStyle = `rgba(99, 102, 241, ${this.opacity})`;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

function initParticles() {
  particles = [];
  for (let i = 0; i < 50; i++) {
    particles.push(new Particle());
  }
}

function animateBackground() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  particles.forEach(particle => {
    particle.update();
    particle.draw();
  });

  // Draw connections
  particles.forEach((p1, i) => {
    particles.slice(i + 1).forEach(p2 => {
      const distance = Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
      if (distance < 100) {
        ctx.strokeStyle = `rgba(99, 102, 241, ${0.1 * (1 - distance / 100)})`;
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
      }
    });
  });

  requestAnimationFrame(animateBackground);
}

initParticles();
animateBackground();

/* =====================================================
   UI HELPERS
===================================================== */
function showToast(message, type = 'info', title = '') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const iconMap = {
    success: 'fa-check',
    error: 'fa-times',
    info: 'fa-info'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">
      <i class="fas ${iconMap[type]}"></i>
    </div>
    <div class="toast-content">
      ${title ? `<div class="toast-title">${title}</div>` : ''}
      <div class="toast-message">${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function updateStats() {
  document.getElementById('matchCount').textContent = state.stats.matches;
  document.getElementById('levelCount').textContent = state.stats.level;
  document.getElementById('totalMatches').textContent = state.stats.matches;
  document.getElementById('likesCount').textContent = state.stats.likes;
  document.getElementById('coinsAmount').textContent = userCoins;
}

function updateTimer() {
  if (isInCall) {
    matchSeconds++;
    const minutes = Math.floor(matchSeconds / 60);
    const seconds = matchSeconds % 60;
    document.getElementById('timeCount').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }
}

/* =====================================================
   PANEL CONTROLS
===================================================== */
function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('open');
}

function toggleProfile() {
  const panel = document.getElementById('profilePanel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) {
    loadProfile();
  }
}

function toggleChat() {
  const panel = document.getElementById('chatPanel');
  panel.classList.toggle('open');
}

function toggleEffects() {
  const panel = document.getElementById('effectsPanel');
  panel.classList.toggle('active');
}

function toggleDeviceSelector() {
  const panel = document.getElementById('deviceSelector');
  panel.classList.toggle('active');
}

/* =====================================================
   PAYMENT MODAL
===================================================== */
function openPaymentModal() {
  document.getElementById('paymentModal').classList.add('active');
  document.getElementById('currentCoins').textContent = userCoins;
  
  // Add click event to coin packages
  document.querySelectorAll('.coin-package').forEach(pkg => {
    pkg.addEventListener('click', function() {
      document.querySelectorAll('.coin-package').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
      selectedCoinPackage = {
        coins: parseInt(this.dataset.coins),
        price: parseFloat(this.dataset.price)
      };
    });
  });
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.remove('active');
  selectedCoinPackage = null;
}

async function purchaseCoins() {
  if (!selectedCoinPackage) {
    showToast('Please select a coin package', 'error');
    return;
  }
  
  try {
    // Create checkout session
    const response = await fetch(`${BACKEND}/api/create-checkout-session`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        coins: selectedCoinPackage.coins,
        price: selectedCoinPackage.price
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to create checkout session');
    }
    
    const { sessionId } = await response.json();
    
    // Initialize Stripe if not already done
    if (!stripe) {
      stripe = Stripe('pk_test_51234567890abcdef'); // Replace with your Stripe publishable key
    }
    
    // Redirect to Stripe Checkout
    const { error } = await stripe.redirectToCheckout({ sessionId });
    
    if (error) {
      showToast(error.message, 'error');
    }
  } catch (error) {
    console.error('Error purchasing coins:', error);
    showToast('Failed to purchase coins', 'error');
  }
}

/* =====================================================
   AGE VERIFICATION
===================================================== */
function showAgeVerification() {
  document.getElementById('ageVerification').style.display = 'flex';
}

async function verifyAge() {
  const age = parseInt(document.getElementById('ageInput').value);
  
  if (!age || isNaN(age)) {
    showToast('Please enter a valid age', 'error');
    return;
  }
  
  if (age < 18) {
    showToast('You must be at least 18 years old to use video features', 'error');
    return;
  }
  
  try {
    const response = await fetch(`${BACKEND}/api/user/verify-age`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ age })
    });
    
    if (!response.ok) {
      throw new Error('Failed to verify age');
    }
    
    const data = await response.json();
    
    if (data.ok) {
      state.user.age_verified = true;
      document.getElementById('ageVerification').style.display = 'none';
      showToast('Age verified successfully', 'success');
    } else {
      showToast(data.error || 'Failed to verify age', 'error');
    }
  } catch (error) {
    console.error('Error verifying age:', error);
    showToast('Failed to verify age', 'error');
  }
}

/* =====================================================
   CHAT SYSTEM
===================================================== */
function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  
  if (!message || !socket || !currentRoom) return;
  
  socket.emit('message', {
    room: currentRoom,
    text: message,
    sender: state.user?.username || 'Anonymous'
  });
  
  addMessageToChat(message, true);
  input.value = '';
}

function addMessageToChat(message, isOwn = false) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isOwn ? 'own' : ''}`;
  
  messageDiv.innerHTML = `
    <div class="message-bubble">
      ${message}
    </div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

/* =====================================================
   MATCHING SYSTEM
===================================================== */
async function startMatching() {
  if (isMatching || isInCall) return;
  
  // Check if user is age verified
  if (!state.user.age_verified) {
    showAgeVerification();
    return;
  }
  
  // Check if permissions are granted
  if (!permissionsGranted) {
    showToast('Camera and microphone permissions are required to start matching', 'error');
    return;
  }
  
  isMatching = true;
  
  // Show blur overlay with matching content
  document.getElementById('blurOverlay').classList.add('active');
  document.getElementById('startControls').style.display = 'none';
  
  try {
    // Start matching
    const response = await fetch(`${BACKEND}/queue/enqueue`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(state.preferences)
    });
    
    if (!response.ok) {
      throw new Error('Failed to enqueue');
    }
    
    const data = await response.json();
    
    if (data.matched) {
      partnerId = data.peerId;
      currentRoom = data.channel;
      startCall();
    } else {
      // Keep trying to match
      setTimeout(() => {
        if (isMatching) {
          checkForMatch();
        }
      }, 2000);
    }
  } catch (error) {
    console.error('Error starting match:', error);
    showToast('Failed to start matching. Please check your camera/microphone permissions.', 'error');
    stopMatching();
  }
}

async function checkForMatch() {
  if (!isMatching) return;
  
  try {
    const response = await fetch(`${BACKEND}/queue/check`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to check queue');
    }
    
    const data = await response.json();
    
    if (data.matched) {
      partnerId = data.peerId;
      currentRoom = data.channel;
      startCall();
    } else {
      setTimeout(checkForMatch, 2000);
    }
  } catch (error) {
    console.error('Error checking for match:', error);
    setTimeout(checkForMatch, 2000);
  }
}

function stopMatching() {
  isMatching = false;
  document.getElementById('blurOverlay').classList.remove('active');
  document.getElementById('startControls').style.display = 'flex';
  
  // Leave queue
  fetch(`${BACKEND}/queue/leave`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }).catch(console.error);
}

/* =====================================================
   CALL SYSTEM
===================================================== */
async function startCall() {
  isMatching = false;
  isInCall = true;
  
  // Hide blur overlay
  document.getElementById('blurOverlay').classList.remove('active');
  document.getElementById('startControls').style.display = 'none';
  document.getElementById('activeControls').style.display = 'flex';
  document.getElementById('partnerInfo').style.display = 'block';
  
  // Start timer
  matchTimer = setInterval(updateTimer, 1000);
  
  try {
    // Get Agora token
    const tokenResponse = await fetch(`${BACKEND}/generateToken`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        channelName: currentRoom,
        uid: Math.floor(Math.random() * 100000)
      })
    });
    
    if (!tokenResponse.ok) {
      throw new Error('Failed to generate token');
    }
    
    const { rtcToken } = await tokenResponse.json();
    
    // Create and join Agora client
    client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    
    await client.join(AGORA_APP_ID, currentRoom, rtcToken, Math.floor(Math.random() * 100000));
    
    // Publish local tracks
    await client.publish([localTracks.audioTrack, localTracks.videoTrack]);
    
    // Handle remote user joining
    client.on('user-published', async (user, mediaType) => {
      await client.subscribe(user, mediaType);
      
      if (mediaType === 'video') {
        user.videoTrack.play('remoteVideo');
      }
      if (mediaType === 'audio') {
        user.audioTrack.play();
      }
    });
    
    // Initialize socket for chat
    initSocket();
    
    // Update stats
    state.stats.matches++;
    updateStats();
    
    showToast('Connected! Say hello to your new friend!', 'success');
    
  } catch (error) {
    console.error('Error starting call:', error);
    showToast('Failed to connect. Please try again.', 'error');
    endCall();
  }
}

function initSocket() {
  socket = io(BACKEND);
  
  socket.emit('auth', { token });
  
  socket.on('message', (data) => {
    addMessageToChat(data.text, false);
  });
  
  socket.on('partner-left', () => {
    showToast('Your partner has left the chat', 'info');
    endCall();
  });
  
  socket.on('partner-info', (data) => {
    updatePartnerInfo(data);
  });
  
  socket.on('match_found', (data) => {
    if (isMatching) {
      partnerId = data.peerId;
      currentRoom = data.channel;
      startCall();
      
      if (data.peerInfo) {
        updatePartnerInfo(data.peerInfo);
      }
    }
  });
}

function updatePartnerInfo(data) {
  document.getElementById('partnerName').textContent = data.username || data.displayName || 'Stranger';
  document.getElementById('partnerLocation').textContent = data.location || 'Unknown';
  document.getElementById('partnerGender').textContent = data.gender || 'Unknown';
  
  // Update interests
  const interestsList = document.getElementById('partnerInterestsList');
  interestsList.innerHTML = '';
  
  if (data.interests && data.interests.length > 0) {
    data.interests.forEach(interest => {
      const tag = document.createElement('div');
      tag.className = 'interest-tag';
      tag.textContent = interest;
      interestsList.appendChild(tag);
    });
    document.getElementById('partnerInterests').textContent = '';
  } else {
    document.getElementById('partnerInterests').textContent = 'No interests';
  }
}

function endCall() {
  isInCall = false;
  isMatching = false;
  
  // Clear timer
  if (matchTimer) {
    clearInterval(matchTimer);
    matchTimer = null;
  }
  
  // Reset UI
  document.getElementById('activeControls').style.display = 'none';
  document.getElementById('startControls').style.display = 'flex';
  document.getElementById('partnerInfo').style.display = 'none';
  document.getElementById('chatPanel').classList.remove('open');
  
  // Clear chat
  document.getElementById('chatMessages').innerHTML = '';
  
  // Leave Agora
  if (client) {
    client.leave();
    client = null;
  }
  
  // Stop tracks
  Object.values(localTracks).forEach(track => track?.stop());
  localTracks = {};
  
  // Disconnect socket
  if (socket) {
    socket.disconnect();
    socket = null;
  }
  
  // Reset match time
  matchSeconds = 0;
  document.getElementById('timeCount').textContent = '0:00';
  
  // Leave queue
  fetch(`${BACKEND}/queue/leave`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }).catch(console.error);
}

/* =====================================================
   PICTURE-IN-PICTURE FUNCTIONALITY
===================================================== */
function togglePiP() {
  const video = document.getElementById('localVideo');
  
  if (!document.pictureInPictureElement) {
    // Enter PiP mode
    if (video.requestPictureInPicture) {
      video.requestPictureInPicture()
        .then(() => {
          isPipActive = true;
          showToast('Picture-in-Picture mode activated', 'success');
        })
        .catch(error => {
          console.error('Error entering PiP mode:', error);
          showToast('Failed to enter Picture-in-Picture mode', 'error');
        });
    }
  } else {
    // Exit PiP mode
    document.exitPictureInPicture()
      .then(() => {
        isPipActive = false;
        showToast('Picture-in-Picture mode deactivated', 'info');
      })
      .catch(error => {
        console.error('Error exiting PiP mode:', error);
      });
  }
}

/* =====================================================
   DRAG FUNCTIONALITY FOR LOCAL VIDEO
===================================================== */
function initDraggableVideo() {
  const localVideoWrapper = document.getElementById('localVideoWrapper');
  let isDragging = false;
  let currentX;
  let currentY;
  let initialX;
  let initialY;
  let xOffset = 0;
  let yOffset = 0;

  function dragStart(e) {
    if (e.type === "touchstart") {
      initialX = e.touches[0].clientX - xOffset;
      initialY = e.touches[0].clientY - yOffset;
    } else {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
    }

    if (e.target === localVideoWrapper || e.target.parentNode === localVideoWrapper || 
        e.target.id === 'localVideo' || e.target.id === 'pipBtn' || e.target.id === 'resetPositionBtn') {
      isDragging = true;
      localVideoWrapper.style.cursor = 'grabbing';
    }
  }

  function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
    localVideoWrapper.style.cursor = 'move';
  }

  function drag(e) {
    if (isDragging) {
      e.preventDefault();
      
      if (e.type === "touchmove") {
        currentX = e.touches[0].clientX - initialX;
        currentY = e.touches[0].clientY - initialY;
      } else {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
      }

      xOffset = currentX;
      yOffset = currentY;

      // Apply new position
      localVideoWrapper.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
  }

  // Add event listeners
  localVideoWrapper.addEventListener('touchstart', dragStart, false);
  localVideoWrapper.addEventListener('touchend', dragEnd, false);
  localVideoWrapper.addEventListener('touchmove', drag, false);
  
  localVideoWrapper.addEventListener('mousedown', dragStart, false);
  document.addEventListener('mouseup', dragEnd, false);
  document.addEventListener('mousemove', drag, false);

  // Reset position function
  window.resetVideoPosition = function() {
    xOffset = 0;
    yOffset = 0;
    localVideoWrapper.style.transform = 'translate(0, 0)';
    localVideoWrapper.style.bottom = '100px';
    localVideoWrapper.style.right = '30px';
    localVideoWrapper.style.top = 'auto';
    localVideoWrapper.style.left = 'auto';
    showToast('Video position reset', 'info');
  };
}

/* =====================================================
   EFFECTS SYSTEM
===================================================== */
function applyEffect(effect) {
  const video = document.getElementById('localVideo');
  const filters = {
    none: '',
    blur: 'blur(5px)',
    grayscale: 'grayscale(100%)',
    sepia: 'sepia(100%)',
    invert: 'invert(100%)',
    contrast: 'contrast(150%)'
  };
  
  video.style.filter = filters[effect] || '';
  
  // Update active state
  document.querySelectorAll('.effect-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.effect === effect);
  });
}

/* =====================================================
   REPORT SYSTEM
===================================================== */
function openReportModal() {
  document.getElementById('reportModal').classList.add('active');
}

function closeReportModal() {
  document.getElementById('reportModal').classList.remove('active');
  document.querySelectorAll('.report-option').forEach(opt => opt.classList.remove('selected'));
  document.getElementById('reportDetails').value = '';
}

async function submitReport() {
  const selectedReason = document.querySelector('.report-option.selected');
  if (!selectedReason) {
    showToast('Please select a reason for reporting', 'error');
    return;
  }
  
  const reason = selectedReason.dataset.reason;
  const details = document.getElementById('reportDetails').value;
  
  try {
    // Send report to backend
    const response = await fetch(`${BACKEND}/api/report`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        reportedUserId: partnerId,
        reason,
        details,
        roomId: currentRoom
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to submit report');
    }
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Report submitted successfully', 'success');
      closeReportModal();
      endCall();
    } else {
      showToast('Failed to submit report', 'error');
    }
  } catch (error) {
    console.error('Error submitting report:', error);
    showToast('Failed to submit report', 'error');
  }
}

/* =====================================================
   GIFTS SYSTEM
===================================================== */
function openGiftsModal() {
  document.getElementById('giftsModal').classList.add('active');
}

function closeGiftsModal() {
  document.getElementById('giftsModal').classList.remove('active');
}

async function sendGift(giftType) {
  const giftCosts = {
    rose: 10,
    heart: 15,
    star: 20,
    diamond: 50,
    crown: 100,
    rocket: 200
  };
  
  const cost = giftCosts[giftType];
  
  if (userCoins < cost) {
    showToast(`You need ${cost} coins to send this gift`, 'error');
    openPaymentModal();
    return;
  }
  
  try {
    // Spend coins
    const response = await fetch(`${BACKEND}/api/user/spend-coins`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        coins: cost,
        type: 'gift',
        giftType,
        recipientId: partnerId
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to spend coins');
    }
    
    const data = await response.json();
    
    if (data.success) {
      // Update coins display
      userCoins -= cost;
      updateStats();
      
      const giftEmojis = {
        rose: 'üåπ',
        heart: '‚ù§Ô∏è',
        star: '‚≠ê',
        diamond: 'üíé',
        crown: 'üëë',
        rocket: 'üöÄ'
      };
      
      // Create gift animation
      const giftElement = document.createElement('div');
      giftElement.className = 'gift-animation';
      giftElement.textContent = giftEmojis[giftType];
      giftElement.style.left = '50%';
      giftElement.style.bottom = '200px';
      document.body.appendChild(giftElement);
      
      setTimeout(() => giftElement.remove(), 3000);
      
      // Send gift via socket
      if (socket) {
        socket.emit('gift', {
          type: giftType,
          to: partnerId,
          room: currentRoom
        });
      }
      
      closeGiftsModal();
      showToast('Gift sent!', 'success');
    } else {
      showToast('Failed to send gift', 'error');
    }
  } catch (error) {
    console.error('Error sending gift:', error);
    showToast('Failed to send gift', 'error');
  }
}

/* =====================================================
   PROFILE & SETTINGS
===================================================== */
async function saveSettings() {
  try {
    const response = await fetch(`${BACKEND}/api/user/preferences`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        gender: document.getElementById('genderSelect').value,
        lookingFor: document.getElementById('lookingForSelect').value,
        location: document.getElementById('locationSelect').value,
        interests: document.getElementById('interestsInput').value.split(',').map(i => i.trim()).filter(i => i),
        nickname: document.getElementById('nicknameInput').value || ''
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to save settings');
    }
    
    const data = await response.json();
    
    if (data.ok) {
      state.preferences = {
        gender: document.getElementById('genderSelect').value,
        lookingFor: document.getElementById('lookingForSelect').value,
        location: document.getElementById('locationSelect').value,
        interests: document.getElementById('interestsInput').value.split(',').map(i => i.trim()).filter(i => i),
        verifiedOnly: document.getElementById('verifiedOnly').checked
      };
      
      localStorage.setItem('preferences', JSON.stringify(state.preferences));
      showToast('Settings saved successfully', 'success');
      toggleSettings();
    } else {
      showToast(data.error || 'Failed to save settings', 'error');
    }
  } catch (error) {
    console.error('Error saving settings:', error);
    showToast('Failed to save settings', 'error');
  }
}

async function loadSettings() {
  try {
    const response = await fetch(`${BACKEND}/api/user/preferences`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load settings');
    }
    
    const data = await response.json();
    
    state.preferences = {
      gender: data.gender || 'male',
      lookingFor: 'any', // This is not in your backend, so defaulting
      location: data.location || 'any',
      interests: data.interests || [],
      verifiedOnly: false // This is not in your backend, so defaulting
    };
    
    document.getElementById('genderSelect').value = state.preferences.gender;
    document.getElementById('lookingForSelect').value = state.preferences.lookingFor;
    document.getElementById('locationSelect').value = state.preferences.location;
    document.getElementById('interestsInput').value = state.preferences.interests.join(', ');
    document.getElementById('verifiedOnly').checked = state.preferences.verifiedOnly;
  } catch (error) {
    console.error('Error loading settings:', error);
    
    // Fallback to localStorage
    const saved = localStorage.getItem('preferences');
    if (saved) {
      state.preferences = JSON.parse(saved);
      document.getElementById('genderSelect').value = state.preferences.gender;
      document.getElementById('lookingForSelect').value = state.preferences.lookingFor;
      document.getElementById('locationSelect').value = state.preferences.location;
      document.getElementById('interestsInput').value = state.preferences.interests.join(', ');
      document.getElementById('verifiedOnly').checked = state.preferences.verifiedOnly;
    }
  }
}

async function saveProfile() {
  const displayName = document.getElementById('displayNameInput').value;
  const bio = document.getElementById('bioInput').value;
  
  if (!displayName) {
    showToast('Please enter a display name', 'error');
    return;
  }
  
  try {
    // Update profile via API
    const response = await fetch(`${BACKEND}/user/display-name`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        display_name: displayName
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to update profile');
    }
    
    const data = await response.json();
    
    if (data.ok) {
      state.user.displayName = displayName;
      document.getElementById('profileName').textContent = displayName;
      showToast('Profile updated successfully', 'success');
    } else {
      showToast(data.error || 'Failed to update profile', 'error');
    }
  } catch (error) {
    console.error('Error updating profile:', error);
    showToast('Failed to update profile', 'error');
  }
}

async function loadProfile() {
  try {
    const response = await fetch(`${BACKEND}/user/profile`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load profile');
    }
    
    const data = await response.json();
    
    state.user = data;
    userCoins = data.coins || 0;
    
    document.getElementById('profileName').textContent = data.username || data.display_name || 'Guest User';
    document.getElementById('displayNameInput').value = data.username || data.display_name || '';
    document.getElementById('bioInput').value = data.bio || '';
    
    // Set avatar if available
    if (data.avatar) {
      document.getElementById('profileAvatar').innerHTML = `<img src="${data.avatar}" style="width: 100%; height: 100%; object-fit: cover;">`;
    }
    
    // Set gender from profile if available
    if (data.gender) {
      state.preferences.gender = data.gender;
      document.getElementById('genderSelect').value = data.gender;
    }
    
    // Show coins if user has any
    if (userCoins > 0) {
      document.getElementById('coinsDisplay').style.display = 'flex';
    }
    
    updateStats();
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

/* =====================================================
   CAMERA SWITCH
===================================================== */
async function switchCamera() {
  if (!permissionsGranted || !availableCameras.length) {
    showToast('Camera permissions not granted or only one camera available', 'info');
    return;
  }
  
  try {
    // Toggle device selector
    toggleDeviceSelector();
  } catch (error) {
    console.error('Error switching camera:', error);
    showToast('Failed to switch camera', 'error');
  }
}

/* =====================================================
   EVENT LISTENERS
===================================================== */
document.getElementById('startBtn').addEventListener('click', startMatching);
document.getElementById('stopBtn').addEventListener('click', endCall);
document.getElementById('nextBtn').addEventListener('click', () => {
  endCall();
  setTimeout(startMatching, 500);
});
document.getElementById('chatBtn').addEventListener('click', toggleChat);
document.getElementById('reportBtn').addEventListener('click', openReportModal);
document.getElementById('giftsBtn').addEventListener('click', openGiftsModal);
document.getElementById('effectsBtn').addEventListener('click', toggleEffects);
document.getElementById('likeBtn').addEventListener('click', () => {
  state.stats.likes++;
  updateStats();
  showToast('You liked this user!', 'success');
  
  // Send like via socket
  if (socket) {
    socket.emit('like', { to: partnerId, room: currentRoom });
  }
});
document.getElementById('cameraBtn').addEventListener('click', switchCamera);
document.getElementById('pipBtn').addEventListener('click', togglePiP);
document.getElementById('resetPositionBtn').addEventListener('click', resetVideoPosition);

// Message input enter key
document.getElementById('messageInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Report options
document.querySelectorAll('.report-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('.report-option').forEach(opt => opt.classList.remove('selected'));
    option.classList.add('selected');
  });
});

// Effects buttons
document.querySelectorAll('.effect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    applyEffect(btn.dataset.effect);
  });
});

// Gift buttons hover effect
document.querySelectorAll('.gift-btn').forEach(btn => {
  btn.addEventListener('mouseenter', () => {
    btn.style.borderColor = 'var(--primary)';
    btn.style.transform = 'scale(1.05)';
  });
  
  btn.addEventListener('mouseleave', () => {
    btn.style.borderColor = 'transparent';
    btn.style.transform = 'scale(1)';
  });
});

/* =====================================================
   INITIALIZATION
===================================================== */
async function initializeApp() {
  try {
    // Hide loading screen
    document.getElementById('loadingScreen').classList.add('hidden');
    
    // Load user profile
    const response = await fetch(`${BACKEND}/user/profile`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load profile');
    }
    
    const data = await response.json();
    state.user = data;
    userCoins = data.coins || 0;
    
    // Load settings
    await loadSettings();
    
    // Load profile
    await loadProfile();
    
    // Initialize draggable local video
    initDraggableVideo();
    
    // Check if user needs age verification
    if (!data.age_verified) {
      showAgeVerification();
    }
    
    // Check for payment success
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment') === 'success') {
      const sessionId = urlParams.get('session_id');
      
      if (sessionId) {
        try {
          const verifyResponse = await fetch(`${BACKEND}/api/verify-payment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ sessionId })
          });
          
          if (verifyResponse.ok) {
            const verifyData = await verifyResponse.json();
            
            if (verifyData.success) {
              userCoins = verifyData.coins;
              updateStats();
              showToast('Payment successful! Coins added to your account.', 'success');
              
              // Clean up URL
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          }
        } catch (error) {
          console.error('Error verifying payment:', error);
        }
      }
    }
  } catch (error) {
    console.error('Error initializing app:', error);
    showToast('Failed to initialize app', 'error');
    
    // If initialization fails, logout user
    setTimeout(() => {
      logout();
    }, 3000);
  }
}

async function init() {
  // First check authentication
  if (!checkAuthentication()) {
    return;
  }
  
  // Show loading screen initially
  document.getElementById('loadingScreen').classList.remove('hidden');
  
  // Check if permissions are already granted
  try {
    const result = await navigator.permissions.query({ name: 'camera' });
    const result2 = await navigator.permissions.query({ name: 'microphone' });
    
    if (result.state === 'granted' && result2.state === 'granted') {
      // Permissions already granted, initialize app
      permissionsGranted = true;
      document.getElementById('permissionOverlay').classList.add('hidden');
      await initializeApp();
    } else {
      // Show permission request overlay
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('permissionOverlay').classList.remove('hidden');
    }
  } catch (error) {
    // Permissions API not supported, show permission request
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('permissionOverlay').classList.remove('hidden');
  }
}

// Initialize app
init();

// Prevent accidental close
window.addEventListener('beforeunload', (e) => {
  if (isInCall) {
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>

</body>
</html>